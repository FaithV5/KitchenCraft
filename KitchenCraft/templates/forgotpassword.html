<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KitchenCraft - Forgot Password</title>
    <link rel="stylesheet" href="../static/css/style.css">
</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">
                <img src="../static/images/logo.png" alt="KitchenCraft" class="logo-icon">
                KitchenCraft
            </div>
            <button id="theme-toggle" class="theme-toggle">ðŸŒ™</button>
        </div>
    </header>

    <main>
        <div class="container">
            <h1 class="page-title">KitchenCraft</h1>
            <div class="form-container">
                <h2>Reset Your Password</h2>
                <p class="form-description">Enter your username to reset your password (no email will be sent in this demo).</p>

                <form id="forgot-password-form">
                    <div class="form-group">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="Enter your username" required>
                    </div>
                    <button type="submit" class="btn">Continue</button>
                </form>
                
                <div class="auth-actions">
                    <a href="login.html" class="link-button">Back to login</a>
                    <a href="register.html" class="btn btn-ghost">Create account</a>
                </div>
            </div>

            <!-- Reset Password Form (hidden by default) -->
            <div id="reset-password-section" class="form-container" style="display: none;">
                <h2>Create New Password</h2>
                <p class="form-description">Enter your new password below for the account you specified.</p>
                
                <form id="reset-password-form">
                    <div class="form-group">
                        <label for="new-password">New Password</label>
                        <input type="password" id="new-password" placeholder="Enter new password" required>
                        <div class="password-requirements">
                            <p>Password must contain:</p>
                            <ul>
                                <li id="length-requirement">At least 8 characters</li>
                            </ul>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="confirm-new-password">Confirm New Password</label>
                        <input type="password" id="confirm-new-password" placeholder="Confirm new password" required>
                        <!-- Show match requirement under the confirm password field -->
                        <div id="match-requirement" class="validation-message">Passwords must match</div>
                    </div>
                    <button type="submit" class="btn">Reset Password</button>
                </form>
            </div>
        </div>
    </main>

    <footer>
        <div class="container footer-content">
            <p>&copy; 2025 KitchenCraft. All rights reserved.</p>
        </div>
    </footer>

    <script src="../backend/store.js"></script>
    <script src="../static/js/script.js"></script>
    <script>
        // Step 1: ask for username and show reset form if found
        document.getElementById('forgot-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = (document.getElementById('username').value || '').toString().trim().toLowerCase();
            if (!username) return alert('Please enter your username');

            try {
                const users = await loadUsers();
                const user = users.find(u => (u.username || '').toString().trim().toLowerCase() === username);
                if (!user) return alert('No account found with that username');

                // remember the username for the reset step
                localStorage.setItem('resetUsername', username);

                // Show the reset password form
                document.getElementById('forgot-password-form').style.display = 'none';
                document.getElementById('reset-password-section').style.display = 'block';
                showNotification('Account found â€” please enter your new password');

                // initialize validation UI (show requirements states)
                validatePassword('');
                validatePasswordMatch();
            } catch (err) {
                console.error('Failed to lookup users for password reset', err);
                alert('An error occurred while looking up your account');
            }
        });

        // Password validation
        document.getElementById('new-password').addEventListener('input', function() {
            validatePassword(this.value);
            // Update match requirement state while typing the new password
            validatePasswordMatch();
        });

        document.getElementById('confirm-new-password').addEventListener('input', function() {
            validatePasswordMatch();
        });

        document.getElementById('reset-password-form').addEventListener('submit', async function(e) {
            e.preventDefault();

            const newPassword = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const username = localStorage.getItem('resetUsername');

            if (!validatePassword(newPassword)) {
                alert('Please fix the password requirements before submitting.');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('Passwords do not match!');
                return;
            }

            try {
                const users = await loadUsers();
                const idx = users.findIndex(u => (u.username || '').toString().trim().toLowerCase() === (username || '').toString().trim().toLowerCase());
                if (idx === -1) return alert('Account not found when saving password');

                // Save new password (no hashing in this demo store)
                users[idx].password = newPassword;

                // Persist using store helper
                await saveUsers(users);

                // Clear reset username
                localStorage.removeItem('resetUsername');

                showNotification('Password reset successfully!');

                // Redirect to login page after a short delay
                setTimeout(() => {
                    try { window.location.href = resolveTemplatePath('login.html'); } catch (e) { window.location.href = 'templates/login.html'; }
                }, 1400);
            } catch (err) {
                console.error('Failed to save new password', err);
                alert('Failed to reset password');
            }
        });

        function validatePassword(password) {
            const lengthReq = document.getElementById('length-requirement');
            
            // Check length
            const hasLength = password.length >= 8;
            lengthReq.style.color = hasLength ? 'green' : 'red';
            
            return hasLength;
        }

        function validatePasswordMatch() {
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-new-password').value;
            const req = document.getElementById('match-requirement');

            if (!req) return false;

            // If confirm is empty, show the hint in red (indicates requirement not yet satisfied)
            if (!confirmPassword) {
                req.style.color = 'red';
                req.textContent = 'Passwords must match';
                return false;
            }

            if (password === confirmPassword) {
                req.style.color = 'green';
                req.textContent = 'Passwords match';
                return true;
            } else {
                req.style.color = 'red';
                req.textContent = 'Passwords must match';
                return false;
            }
        }
    </script>
</body>
</html>

